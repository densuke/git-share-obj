# git-share-obj

`git-share-obj` は、指定ディレクトリ配下を再帰探索し、複数の Git リポジトリに存在する同一オブジェクト (`.git/objects/xx/yyyy...`) をハードリンクで共有する Rust ツールです。

重複オブジェクトの実体を 1 つに集約してストレージを節約できますが、**ファイルを実際に削除して置換する危険な処理**を行います。必ずバックアップを取ってから使用してください。

## 概要

- 対象: 指定パス配下のすべての `.git/objects`
- 対象外: `.git/objects/pack`, `.git/objects/info`
- 重複判定: `xx` + `yyyy...` の 40 文字 SHA-1 形式ファイル名（同一ハッシュ）
- 共有方式: 重複ファイルを削除し、代表ファイルへのハードリンクに置換
- 前提環境: ハードリンクを使える UNIX 系 OS（Linux/macOS など）

## 詳細（実装ベース）

### 1. 探索

- `scan_git_objects()` が `WalkDir` で指定ディレクトリ以下を走査
- `.git/objects` を見つけたら、その直下 2 階層 (`objects/xx/file`) のみを対象に収集
- オブジェクトとして有効なのは次の形式のみ
  - ディレクトリ名 2 文字の 16 進
  - ファイル名 38 文字の 16 進

### 2. グルーピング

- まずデバイス ID (`st_dev`) ごとに分割（異なるファイルシステム間ではハードリンク不可）
- 同一デバイス内でハッシュ値ごとにグループ化
- 各ハッシュグループで `(device, inode)` ごとにサブグループ化

### 3. 代表 (`source`) の選び方

- 最もメンバー数が多い inode サブグループを優先（既存ハードリンク集合を維持するため）
- そのサブグループ内で最も古い `modified` 時刻のファイルを `source` として選択
- `source` 以外のサブグループに属するファイルが置換対象 (`duplicates`)

### 4. 置換処理

各 duplicate について `replace_with_hardlink(source, target)` を実行:

1. 同一ファイルシステムか確認
2. すでに同一 inode ならスキップ
3. `target` を削除
4. `source` へのハードリンクを `target` パスに作成

## 使用方法

### ドライラン（推奨）

```bash
cargo run -- -n -v /path/to/search-root
```

- `-n` / `--dry-run`: 変更せず検出結果のみ表示
- `-v` / `--verbose`: 詳細表示
- 引数なしの場合はカレントディレクトリ (`.`) を探索

### 実行

```bash
cargo run -- -v /path/to/search-root
```

複数パス指定も可能です。

```bash
cargo run -- -n -v /repo/a /repo/b /repo/c
```

## 危険性

このツールは設計上、以下のリスクがあります。

- データ損失リスク:
  - 置換時は `target` を先に削除し、その後ハードリンクを作成します。
  - 削除後に失敗すると、`target` の実体は失われます（ロールバックなし）。
- 競合リスク:
  - 実行中に `git gc`, `git repack`, `git prune` や他プロセスが同じオブジェクトを操作すると不整合の可能性があります。
- スキャン範囲リスク:
  - 指定ディレクトリ配下のすべての `.git/objects` が対象です。意図しないリポジトリまで処理する恐れがあります。
- 内容検証なし:
  - ファイル名（ハッシュ）ベースで重複とみなし、オブジェクト内容の再検証（`git fsck` 相当）は行いません。
- 節約量表示は理論値:
  - エラーやスキップがあっても、集計上の削減量は事前見積もりベースです。

### 安全に使うための最低限の手順

1. 対象ディレクトリ全体をバックアップする
2. まず `--dry-run` で対象を確認する
3. Git の重いメンテナンス処理と同時実行しない
4. 実行後に必要なら `git fsck` で健全性確認する

## ビルド方法

### 前提

- Rust（stable）
- Cargo
- UNIX 系環境（Linux/macOS）

### ビルド

```bash
cargo build
```

### テスト

```bash
cargo test
```

## ライセンス

本プロジェクトは **GNU General Public License version 2 only (GPL-2.0-only)** です。

- `Cargo.toml` の `license` は `GPL-2.0-only`
- 標準 GPLv2 本文を `COPYING` に同梱（Linus 注記なし）
